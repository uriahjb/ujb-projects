/* ---------------------------------------------------------------------------- */
/* (CPP)
   Property List: 
      - Capable of containing the following types:         
         - char
         - byte
	 - int
	 - unsigned int
	 - word
	 - long

      - Has methods:
         - Get:
	     returns string of single property
	 - Set:
	     sets the value for a single property
*/
/* ----------------------------------------------------------------------------- */


/* ------------------------------------------------------------------------ */
/* Includes */
/* ------------------------------------------------------------------------ */
#include "WProgram.h"
#include "PropertyList.h"

/* ------------------------------------------------------------------------ */
/* Method Declarations */
/* PropertyList class:
     - contains:
          property struct
	  current append index
	  number of properties
	  get_flag
*/
/* ------------------------------------------------------------------------ */	  

/* ------------------------------------------------------------------------ */
/* Construct PropertyList, declare memory for property_list, and
   take note of num_properties
*/
/* ------------------------------------------------------------------------ */
PropertyList::PropertyList(int n, String name){
  
  property_list = (property_t*)malloc(n*sizeof(property_t));
  num_properties = n;
  list_name = name;
}


/* ------------------------------------------------------------------------ */
/* Set values for given property in property_list with name */
/* ------------------------------------------------------------------------ */
int PropertyList::Set(int index, int type, int length, void *data, char *name){

  /* If index too great, fail */
  if (index > num_properties){
    return 0;
  }

  /* Check if property has been initialized */
  if (property_list[index].initialized == false){
    property_list[index].initialized = true;
  }

  /* Assign type, length, and data */
  property_list[index].type = type;
  property_list[index].length = length;
  property_list[index].data = data;

  /* Assign a name ... this is basically strcpy */
  unsigned i;
  for (i = 0; name[i] != '\0'; ++i){
    /* If greater than max name length otherwise continue assign*/
    if (i > 9){
      property_list[index].name[i] = '\0';
      return 0;
    }else{
      property_list[index].name[i] = name[i];    
    }
  }
  property_list[index].name[i] = '\0';

  return 1;
}

/* ------------------------------------------------------------------------ */
/* Set values for given property in property_list without name */
/* ------------------------------------------------------------------------ */
int PropertyList::Set(int index, int type, int length, void *data){

  /* If index too great, fail */
  if (index > num_properties){
    return 0;
  }
  
  /* Check if property has been initialized */
  if (property_list[index].initialized == false){
    property_list[index].initialized = true;
    property_list[index].name[0] = '\0';
  }
  /* Assign type, length, and data */
  property_list[index].type = type;
  property_list[index].length = length;
  property_list[index].data = data;

  return 1;
}

/* ------------------------------------------------------------------------ */
/* Set a value that has already been initialized, 
     note: this can return nonesense if the data assigned
           doesn't align with the initialization type
*/
/* ------------------------------------------------------------------------ */
int PropertyList::Set(int index, void *data){

  /* If index too great, fail */
  if (index > num_properties){
    return 0;
  }
  
  /* Check if property has been initialized, if not fail */
  if (property_list[index].initialized == false){
    return 0;
  }
  /* Assign new data */
  property_list[index].data = data;

  return 1;
}

/* ------------------------------------------------------------------------ */
/* Get values for given property in property_list */
/* ... currently by assigning to string */
/* ------------------------------------------------------------------------ */
String PropertyList::Get(int index){
 
  /* If index too great, don't get */
  /* Note: need to make this compile error */
  if (index > num_properties){
    String str_error = String("PropertyList::Get; index greater than num_properties");
    return str_error;
  }


  property_t *pl = property_list;
  
  int type;
  int length;
  int i;
  
  String str_space = String(" ");
  /* Start with list name and then append item name */
  String str_out = String(list_name);
  str_out += str_space;
  str_out += String((char*)pl[index].name);
  str_out += str_space;
  

  String str_cur;

  switch(pl[index].type){    
  
  case Char: {
    char *dp = (char*)pl[index].data;
    for (i = 0; i < (pl[index].length); i++){
      str_out += String(dp[i]);
    }
    break;
  }

  case Int: {
    int *dp = (int*)pl[index].data;
    for (i = 0; i < (pl[index].length); i++){
      str_out += String(dp[i], DEC);
      // Add a space between ints for funz
      str_out += str_space;
    }
    break;
  }
  
    
  }
  return str_out;
}


/* ------------------------------------------------------------------------ */
/* 
   Get all properties in property list, this is probably a bad method
   use most of the time as it can return a crazy long string
*/
/* ------------------------------------------------------------------------ */
String PropertyList::Get(){
 

  property_t *pl = property_list;
  
  int type;
  int length;
  int i;

  String str_space = String(" ");
  String str_newline = String("\n");
  /* Start with list name and then append item name */
  String str_out = String(list_name);
  str_out += str_space;

  String str_cur;

  int index;
  for (index = 0; index < num_properties; ++index){

    if (pl[index].initialized == true){

      str_out += String((char*)pl[index].name);
      str_out += str_space;


      switch(pl[index].type){    
	
      case Char: {
	char *dp = (char*)pl[index].data;
	for (i = 0; i < (pl[index].length); i++){
	  str_out += String(dp[i]);
	}
	break;
      }
	
      case Int: {
	int *dp = (int*)pl[index].data;
	for (i = 0; i < (pl[index].length); i++){
	  str_out += String(dp[i], DEC);
	  // Add a space between ints for funz
	  str_out += str_space;
	}
	break;
      }
      }

      /* If not last index, then append newline */
      if ((num_properties - index) != 0){
	str_out += str_newline;
      }
       
    }
  }
  return str_out;
}
  
